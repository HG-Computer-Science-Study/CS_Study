### 키워드

`뮤텍스 락`, `세마포`, `모니터`

### 시작하기 전에

- 동기화를 위한 도구 : 뮤텍스 락, 세마포, 모니터

# 뮤텍스 락

- **뮤텍스 락** : 상호 배제를 위한 동기화 도구
  - 프로세스는 임계 구역이 잠겨 있다면 (다른 프로세스가 해당 임계 구역에 있다면) 해당 임계 구역에 접근하지 못하고, 잠겨있지 않다면 접근할 수 있다.
- 뮤텍스 락 구현
  - 자물쇠 역할 : 프로세스들이 공유하는 전역 변수 lock
  - 임계 구역을 잠그는 역할 : acquire 함수
  - 임계 구역의 잠금을 해제하는 역할 : release 함수
- **acquire 함수** : 프로세스가 임계 구역에 진입하기 전에 호출하는 함수
  - 임계 구역이 잠겨 있다면 : 임계 구역이 열릴 때까지 (lock이 false가 될 때까지) 임계 구역을 반복적으로 확인
    - **바쁜 대기** : 임계 구역이 잠겨 있는지 반복적으로 확인하는 것
  - 임계 구역이 열려 있다면 : 임계 구역을 잠근다(lock을 true로 만든다)
- **release 함수** : 임계 구역에서의 작업이 끝나고 호출하는 함수
  - 현재 잠긴 임계 구역을 열어주는 (lock을 false로 바꾼다) 함수

```java
// 아래와 같이 임계 구역 전후로 acquire과 release를 호출해서 하나의 프로세스만
// 임계 구역에 진입하도록 할 수 있다.

acquire(); // 자물쇠 잠겨 있는지 확인, 열려 있다면 잠그고 진입
//임계 구역 작업 진행
release(); //자물쇠 반환
```

- C/C++, Python과 같은 프로그래밍 언어에는 뮤텍스 락 기능이 있다.

[자바에서 뮤텍스 락 적용하기](https://www.notion.so/19355b4716c7808b8d37f7fe956f2784?pvs=21)

[하나의 서버는 동시에 몇 개의 스레드를 감당할 수 있을까?](https://www.notion.so/19355b4716c78018bb08e131382d49d6?pvs=21)

# 세마포

## 세마포란?

- **세마포(semaphore)** : **공유 자원이 여러 개** 있는 상황에서도 적용이 가능한 동기화 도구
  - 뮤텍스 락은 **하나의 공유 자원**에 접근하는 프로세스를 상정한 방식이라는 점에서 세마포와 차이가 있다.
  - 세마포의 종류
    - 이진 세마포 : 뮤텍스 락과 비슷한 개념
    - **카운팅 세마포** : 여러 개의 공유 자원을 다룰 수 있다. 이번에 배울 내용임

## 세마포를 이용한 상호 배제를 위한 동기화 기법

### 세마포의 구현 : 기초

- 전역 변수 S : 임계 구역에 진입할 수 있는 프로세스의 개수(사용 가능한 공유 자원의 개수)를 나타냄
- wait 함수 : 임계 구역에 들어가도 좋은지, 기다려야 할지 알려줌
- signal 함수 : 임계 구역 앞에서 기다리는 프로세스에 ‘들어가도 좋다’고 신호를 주는 함수

```java
wait()
// 임계 구역
signal()

wait() {
		while (S <= 0) { // 임계 구역에 진입할 수 있는 프로세스 개수가 0 이하라면
				// 사용 가능한 자원이 있는지 반복 확인
		}
		S--; // 임계 구역에 진입할 수 있는 프로세스 개수가 하나 이상이면 S를 1 감소시키고 임계 구역에 진입
}

signal() {
		S++; // 임계 구역에서의 작업을 마친 뒤 S를 1 증가시킨다.
}
```

- 이 방법의 문제점 : 사용할 수 있는 공유자원이 없는 경우 프로세스는 무한정 S를 확인해야 한다 → CPU 낭비

### 세마포의 구현 : 심화

```java
wait()
// 임계 구역
signal()

wait() {
		S--;
		if (S < 0) { // 사용할 수 있는 자원이 없는 경우
				// 해당 프로세스 PCB를 대기 큐에 삽입
				sleep(); // 대기 상태로 접어든다
		}
}

signal() {
		S++;
		if (S <= 0) {
				// 대기 큐에 있는 프로세스 p를 제거한다
				wakeup(p); // 프로세스 p를 대기 상태에서 준비 상태로 만든다
		}
}
```

- 참고 : S값을 가장 먼저 조정하는 이유는 **경쟁 상태(race condition)를 방지하고, 올바른 동기화를 보장하기 위해서**임
  1. `wait()`에서 `S--`를 먼저 실행하는 이유 : 자원이 남아있는지 **즉시 판단**하기 위함
     1. 만약 if문 안에서 `S--`를 수행하면 문제가 생길 수 있다
        1. 여러 프로세스가 동시에 `wait()`를 호출하면 if문이 실행되기 전에 다른 프로세스가 S값을 바꿔버릴 수 있다. ⇒ S값이 변경되기 전에 다른 프로세스가 개입할 수 있는 위험 발생
        2. 이 경우 자원이 없는데도 대기하지 않고 실행을 계속하는 프로세스가 생길 수 있다.
  2. `signal()`에서 `S++`가 먼저 실행되는 이유
     1. 자원이 반환되었음을 즉시 반영하기 위함
     2. `wakeup(p)`가 실행되기 전에 다른 프로세스가 `wait()`를 호출해서 S값을 바꿔버릴 수 있음
     3. 원래 대기중이던 프로세스가 깨워지지 않는 버그가 발생할 수 있다

## 세마포를 이용해 프로세스의 순서를 제어하는 방법

- 세마포의 변수 S를 0으로 둔다
- 먼저 실행할 프로세스 뒤에 signal 함수를 붙인다
- 다음에 실행할 프로세스 앞에 wait 함수를 붙인다.

[Java로 공부하는 세마포](https://www.notion.so/Java-19455b4716c780f4b44dfc2cd48e7285?pvs=21)

# 모니터

- 세마포어는 일일이 wait와 signal 함수를 명시해야 하기 때문에 번거롭고 실수의 여지가 있다
- **모니터** : 세마포어보다 편한 동기화 도구
- 모니터의 특징
  - 공유자원과 공유자원에 접근하기 위한 인터페이스를 묶어 관리한다.
  - 프로세스는 반드시 인터페이스를 통해서만 공유 자원에 접근 가능하다
- 상호배제를 위한 동기화
  - 공유 자원을 다루는 인터페이스에 접근하기 위한 큐를 만들고, 모니터 안에 항상 하나의 프로세스만 들어오도록 하여 상호 배제를 위한 동기화를 제공한다
- 실행 순서 제어를 위한 동기화
  - 조건 변수 : 프로세스나 스레드의 실행 순서를 제어하기 위해 사용하는 변수
  - 조건 변수는 wait와 signal 연산을 수행할 수 있다
    - wait : 호출한 프로세스의 상태를 대기 상태로 전환하고 일시적으로 조건 변수에 대한 대기 큐에 삽입하는 연산
      - 참고 : 상호배제를 위한 동기화에 사용되는 큐 ≠ 조건 변수에 대한 큐
