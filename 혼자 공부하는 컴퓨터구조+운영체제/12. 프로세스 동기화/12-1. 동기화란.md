### 키워드

`동기화`, `공유 자원`, `임계 구역`, `상호 배제`

### 시작하기 전에

- 동기화란 무엇일가?
- 프로세스를 동기화하지 않을 경우 어떤 문제들이 발생할까?

# 동기화의 의미

- **프로세스 동기화** : 특정 자원에 접근할 때 한 개의 프로세스만 접근하게 하거나, 프로세스를 올바른 순서대로 실행하게 하는 것
  - **실행 순서 제어** : 프로세스를 올바른 순서대로 실행하기
  - **상호 배제** : 동시에 접근해서는 안 되는 자원에 하나의 프로세스만 접근하게 하기
    <aside>
    💡
    
    참고 : 프로세스 뿐만 아니라 스레드도 동기화의 대상이다.
    
    </aside>


### 실행 순서 제어를 위한 동기화

- 동시에 실행되는 프로세스를 올바른 순서대로 실행하는 것
- 예시
  - Book.txt에 값을 저장하는 writer프로세스와, Book.txt의 내용을 읽는 reader 프로세스가 있다
  - writer 프로세스가 실행된 이후에 reader 프로세스를 실행해야 정상작동할 수 있다 → 동기화 필요

### 상호 배제를 위한 동기화

- **상호 배제** : 공유가 불가능한 자원의 동시 사용을 피하기 위해 사용하는 알고리즘
- 예시
  - 계좌 잔액 : 10만원
  - 프로세스 A : 계좌 잔액에 2만원을 더하고, 더한 값을 저장
  - 프로세스 B : 계좌 잔액에 5만원을 더하고, 더한 값을 저장.
  - 다음과 같은 순서대로 프로세스가 실행된다고 생각해보자
    - A가 잔액(10만)을 읽어들인 후, 2만원을 더함 → 12만
    - B가 잔액(10만)을 읽어들인 후, 5만원을 더함 → 15만
    - A가 계좌의 잔액을 저장 → 계좌 잔액 : 12만
    - B가 계좌의 잔액을 저장 → 계좌 잔액 :15만
    - 최종 잔액 : 15만
  - 원래대로라면 17만원이 저장되어야 하지만, 두 프로세스가 동시에 실행되어 엉뚱한 값인 15만원이 저장되었다.
  - 동기화를 통해 프로세스 A가 잔액에 접근했을 때, 프로세스 B는 해당 잔액에 접근하지 못하도록 해야 한다.

# 생산자와 소비자 문제

- **상호 배제를 위한 동기화**에 대한 문제
- 생산자 : 물건을 생산하는 프로세스. 버퍼에 물건을 넣은 후, ‘sum’ 변수를 1 증가
- 소비자 : 물건을 소비하는 프로세스. 버퍼에서 물건을 뺀 후, ‘sum’ 변수를 1 감소
- sum = 10으로 초기화 한 후, 생산자 프로세스와 소비자 프로세스를 동시에 100,000번 실행한다면?
  - 기댓값 : 10
  - 실제 값 : 엉뚱한 수 (ex. 83911) → 두 프로세스를 동기화하지 않고 실행했기 때문임.
- 참고 : https://github.com/kangtegong/self-learning-cs/blob/main/producer_consumer/producer_consumer.md

# 공유 자원과 임계 구역

- 동시에 접근해서는 안 되는 자원이란?
  - **공유 자원** 중에 두 개 이상의 프로세스를 동시에 실행하면 문제가 발생하는 자원
  - 공유 자원 : 공동으로 이용하는 변수, 파일, 장치 등의 자원
- **임계 구역** : 동시에 실행하면 문제가 발생하는 자원에 접근하는 코드 영역
  - 두 개 이상의 프로세스가 임계 구역에 진입하고자 하면 둘 중 하나는 대기해야 한다.
- **레이스 컨디션** : 여러 프로세스가 동시 다발적으로 임계 구역의 코드를 실행하여 문제가 발생하는 경우
  - 레이스 컨디션이 발생하면 데이터의 일관성이 깨지는 문제가 발생한다.
- 레이스 컨디션이 발생하는 이유
  - 고급 언어로 작성한 `sum++`이라는 코드는 실행 과정에서 다음과 같이 저급 언어 여러 줄로 변환된다.
    ```java
    r1 = sum; // 총합 변수를 레지스터에 저장
    r1 = r1 + 1; // 레지스터 값 1 증가
    sum = r1; // 레지스터 값을 총합 변수에 저장
    ```
  - 위 저급 언어를 실행하는 과정에서 다른 프로세스를 실행하는 문맥 교환이 일어날 수 있는데, 이 경우 레이스 컨디션이 발생하게 된다.
- 상호 배제를 위한 동기화의 세 가지 원칙
  1. **상호 배제** : 한 프로세스가 임계 구역에 진입했다면 다른 프로세스는 임계 구역에 들어올 수 없다
  2. **진행** : 임계 구역에 어떤 프로세스도 진입하지 않았다면 임계 구역에 진입하고자 하는 프로세스는 들어갈 수 있어야 한다
  3. **유한 대기** : 한 프로세스가 임계 구역에 진입하고 싶다면 그 프로세스는 언젠가는 임계 구역에 들어올 수 있어야 한다 (무한정 대기 방지)
